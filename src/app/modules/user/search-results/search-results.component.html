<section class="min-h-[calc(100vh-80px)] py-8 md:py-4 mt-16 lg:mt-0">
  <!-- Input y botón -->
  <div class="flex gap-1 md:gap-2 w-full mt-6">
    <div class="w-full">
      <p-floatlabel variant="on">
        <input pInputText id="over_label" [(ngModel)]="term" (keyup.enter)="searchTerm()" class="w-full" />
        <label for="on_label">
          <i class="pi pi-search mr-2"></i>
          Buscar producto...
        </label>
      </p-floatlabel>
    </div>

    <p-button label="Buscar" icon="pi pi-search" [disabled]="term.length < 7" [loading]="loading()"
      (onClick)="searchTerm()" />

    <p-button [icon]="sortOrder() === 'asc' ? 'pi pi-sort-amount-down' : 'pi pi-sort-amount-up'" [text]="true"
      [rounded]="true" severity="secondary" (click)="toggleSortOrder()"
      pTooltip="{{sortOrder() === 'asc' ? 'Ordenar de mayor a menor precio' : 'Ordenar de menor a mayor precio'}}"
      tooltipPosition="top">
    </p-button>
  </div>

  @if (isLoading()) {
  <div class="mt-4 grid grid-cols-2 gap-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5">
    @for (item of [1,2,3,4,5,6,7,8,9,10]; track $index) {
    <skeleton-prod />
    }
  </div>
  }

  @if (!isLoading()) {

  @if (productsFound().length >= 1 && !isGeneric()) {
  <div class="card flex justify-center mt-6">
    <p-fieldset legend="Productos que rastreamos">
      <div class="grid mt-3 grid-cols-2 gap-2 sm:gap-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5">
        @for (product of productsFound(); track product.urlId) {
        <div>
          
<p-card [style]="{ width: '100%', overflow: 'hidden', height: '100%' }"
        styleClass="[&_.p-card-body]:!p-2 sm:[&_.p-card-body]:!p-4 border border-green-500/50">
        <ng-template #header>
          <div class="bg-white relative">
            <img [alt]="product.productTitle"
              class="h-52 md:h-[362px] xl:h-[302px] w-full m-auto cursor-pointer object-contain"
              [src]="product.image" [routerLink]="['/seguimientos', product.urlId]" />

            <!-- Badge de descuento sobre la imagen -->
            @if (product.discountPercentage != 0 && product.discountPercentage != null) {
              <div class="absolute top-2 left-2">
                <p-badge [value]="'↓ ' + product.discountPercentage + '%'" severity="contrast" 
                styleClass="badge-overlay shadow-lg" />
              </div>
            }

            <!-- Corazón sobre la imagen -->
            <div class="absolute top-2 right-2">
              @if (isAuthenticated) {
                @if (getMyJob(product.urlId)) {
                  <div class="heart-overlay heart-filled" pTooltip="Siguiendo" tooltipPosition="bottom"
                    (click)="deleteUrl(product.urlId)">
                    <i class="pi pi-heart-fill text-lg"></i>
                  </div>

                  
                } @else {
                  <div class="heart-overlay heart-empty" 
                    pTooltip="Empezar a seguir" tooltipPosition="bottom" 
                    (click)="addUrlForMe(product.job, product.urlId)">
                    <i class="pi pi-heart text-lg hover:pi-heart-fill"></i>
                  </div>
                }
              } @else {
                <div class="heart-overlay heart-empty" 
                  pTooltip="Empezar a seguir" tooltipPosition="bottom"
                  (onClick)="onLoginClick()">
                  <i class="pi pi-heart text-lg"></i>
                </div>
              }
            </div>
          </div>
        </ng-template>
        <ng-template #title>
          <div class="text-sm md:text-lg line-clamp-2 leading-relaxed">
            {{ product.productTitle | titlecase }}
          </div>
        </ng-template>
        <ng-template #subtitle>
          <div class="flex flex-col items-start gap-1 sm:flex-row sm:items-center sm:gap-2 cursor-pointer"
            [routerLink]="['/seguimientos', product.urlId]">
            <img class="h-5" src="../../../../assets/svg/{{ product.url | extractDomain }}.svg"
              alt="Logo {{ product.url | extractDomain }}" />
            <small>({{ product.lastUpdate | timeAgo }}) <i class="pi pi-clock ml-1 text-xs"></i></small>
          </div>
        </ng-template>
        <div class="cursor-pointer" [routerLink]="['/seguimientos', product.urlId]">
          <h2 class="text-lg sm:text-2xl">
            {{ product.currentPrice | currency : "S/ " }}
          </h2>
          <h3 class="text-sm marfa-italic-md mb-3"
            [style.visibility]="product.currentPrice >= product.previousPrice ? 'hidden' : 'visible'">
            Antes:
            <samp class="line-through">{{
              product.previousPrice | currency : "S/"
            }}</samp>
          </h3>
        </div>
        <ng-template #footer>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2 my-2">
            <p-button label="Detalles" severity="contrast" icon="pi pi-chart-line" class="flex-1"
              styleClass="w-full" size="small" [routerLink]="['/seguimientos', product.urlId]" />
            @if (isAuthenticated) {
              @if (getMyJob(product.urlId)) {
                <p-button label="No seguir" severity="danger" icon="pi pi-times" class="flex-1" outlined="true"
                  styleClass="w-full" size="small" (click)="deleteUrl(product.urlId)" />
              } @else {
                <p-button label="Seguir" icon="pi pi-heart" class="flex-1"
                  styleClass="w-full" size="small" (onClick)="addUrlForMe(product.job, product.urlId)" />
              }
            } @else {
              <p-button label="Seguir" icon="pi pi-heart" class="flex-1"
                styleClass="w-full" size="small" outlined="true" (onClick)="onLoginClick()" />
            }
          </div>
        </ng-template>
      </p-card>
        </div>
        }
      </div>
    </p-fieldset>
  </div>
  }

  <h3 class="text-center heading-3 mt-8">Resultados de internet</h3>

  <div class="mt-4 grid grid-cols-2 gap-2 sm:gap-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5">
    @for (product of sortedResults(); track $index) {
    <div>
      <p-card [style]="{ width: '100%', overflow: 'hidden', height: '100%' }"
        styleClass="[&_.p-card-body]:!p-2 sm:[&_.p-card-body]:!p-4">
        <ng-template #header>
          <div class="bg-white">
            <img [alt]="product.name" class="h-52 md:h-[362px] xl:h-[302px] w-full m-auto cursor-pointer object-contain"
              [src]="product.image" />
          </div>
        </ng-template>
        <ng-template #title>
          <div class="text-sm md:text-lg">
            {{ truncateText(product.name) | titlecase }}
          </div>
        </ng-template>
        <ng-template #subtitle>
          <div class="flex flex-row items-start gap-1 sm:items-center text-sm">
            <img class="h-5" src="../../../../assets/svg/{{ product.store }}.svg" alt="Logo {{ product.store }}" />
            {{ product.store | titlecase }}
          </div>
        </ng-template>
        <div class="cursor-pointer">
          <h2 class="text-lg sm:text-2xl">
            {{ product.price| currency : "S/ " }}
          </h2>
        </div>
        <ng-template #footer>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2 my-2">
            <a [href]="product.url+'?utm_source=droply.pe&utm_medium=referral'" target="_blank">
              <p-button label="Comprar" severity="secondary" icon="pi pi-shopping-cart" class="flex-1"
                styleClass="w-full" size="small" />
            </a>

            @if (isAuthenticated) {
            <p-button label="Seguir" icon="pi pi-heart" class="flex-1" styleClass="w-full" size="small"
              (click)="registrarUrl(product.url)" [loading]="isUrlLoading(product.url)" />
            } @else {
            <p-button label="Seguir" icon="pi pi-heart" (onClick)="onLoginClick()" class="flex-1" styleClass="w-full"
              size="small" />
            }
          </div>
        </ng-template>
      </p-card>
    </div>
    }
  </div>
  }

  @if (!isLoading() && results().length === 0) {
  <div class="flex flex-col items-center justify-center py-12 text-center">
    <i class="pi pi-search text-6xl text-gray-400 mb-4"></i>
    <h3 class="text-xl font-medium text-gray-600 mb-2">No se encontraron productos</h3>
    <p class="text-gray-500 mb-6">
      @if (term) {
      No encontramos resultados para "{{term}}"
      }
    </p>

    @if (term) {
    <button pButton pRipple label="Limpiar filtros" icon="pi pi-filter-slash" class="p-button-outlined"
      (click)="clearFilters()"></button>
    }
  </div>
  }
</section>

<!-- Diálogo de búsqueda genérica mejorado -->
<p-dialog maskStyleClass="backdrop-blur-sm" [modal]="true" [(visible)]="isGeneric"
  [style]="{ width: '90%', maxWidth: '500px' }" [breakpoints]="{'960px': '75vw', '640px': '90vw'}">

  <ng-template #header>
    <div class="inline-flex items-center justify-center gap-2">
      <i class="pi pi-info-circle text-blue-500"></i>
      <h2 class="font-bold text-xl">Búsqueda muy general</h2>
    </div>
  </ng-template>

  <div class="text-center mb-2">
    <i class="pi pi-exclamation-triangle text-4xl text-yellow-500 mb-3"></i>
    <p class="p-text-secondary mb-6">Para obtener resultados más precisos, prueba con alguno de estos términos:</p>
  </div>

  <div class="flex flex-wrap gap-2 justify-center">
    @for (sug of suggestions(); track $index) {
    <p-button [label]="sug | titlecase" (click)="selectSuggestion(sug, true)" class="cursor-pointer"
      styleClass="p-button-outlined p-button-secondary" />
    }
    <p-button [label]="'Continuar con la búsqueda de: ' + term" (click)="selectSuggestion(term, true)"
      class="cursor-pointer" styleClass="p-button-outlined p-button-primary" />
  </div>

</p-dialog>

<p-toast [breakpoints]="{ '780px': { width: '80%', right: '8' } }" />
